<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Aggregator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #ffffff 0%, #1e3a8a 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spin {
            animation: spin 1s linear infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        const app = document.getElementById('app');
        
        let state = {
            loading: false,
            currentStep: 0,
            report: null,
            error: '',
            sources: null
        };

        const steps = [
            { id: 1, label: 'Fetching RSS Feeds', icon: 'üì°' },
            { id: 2, label: 'Gathering Research Papers', icon: 'üìö' },
            { id: 3, label: 'Summarizing Content', icon: 'üìù' },
            { id: 4, label: 'Generating Report', icon: '‚úÖ' }
        ];

        function setState(newState) {
            state = { ...state, ...newState };
            render();
        }

        async function loadSources() {
            try {
                const response = await fetch('/api/sources');
                const data = await response.json();
                setState({ sources: data });
            } catch (err) {
                console.error('Failed to load sources:', err);
            }
        }

        async function handleGenerate() {
            setState({ loading: true, error: '', report: null, currentStep: 0 });

            try {
                // Animate steps
                for (let i = 1; i <= 4; i++) {
                    setState({ currentStep: i });
                    await new Promise(resolve => setTimeout(resolve, i === 4 ? 1000 : 2000));
                }

                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error || 'Failed to generate report');

                setState({ report: data, loading: false, currentStep: 0 });
            } catch (err) {
                setState({ error: err.message, loading: false, currentStep: 0 });
            }
        }

        function downloadMarkdown() {
            if (!state.report) return;
            
            const content = `# AI/ML Weekly News Report\nGenerated: ${state.report.date}\nTotal Articles: ${state.report.articles_count}\n\n${state.report.report}`;
            
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai_news_report_${state.report.date}.md`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadHTML() {
            if (!state.report) return;
            
            const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI/ML Weekly News - ${state.report.date}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; line-height: 1.6; color: #333; }
        h1 { color: #1e3a8a; border-bottom: 3px solid #1e3a8a; padding-bottom: 10px; }
        h2 { color: #1e40af; margin-top: 40px; }
        a { color: #1e3a8a; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .meta { color: #666; font-size: 0.9em; margin-bottom: 30px; }
    </style>
</head>
<body>
    <h1>AI/ML Weekly News Report</h1>
    <div class="meta">Generated: ${state.report.date} | ${state.report.articles_count} articles</div>
    ${state.report.report.replace(/\n/g, '<br>')}
</body>
</html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai_news_report_${state.report.date}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyToClipboard() {
            if (!state.report) return;
            
            const content = `# AI/ML Weekly News Report\nGenerated: ${state.report.date}\n\n${state.report.report}`;
            navigator.clipboard.writeText(content).then(() => {
                alert('Report copied to clipboard!');
            });
        }

        function formatMarkdown(text) {
            // Basic markdown to HTML conversion
            return text
                .replace(/### (.*?)$/gm, '<h3 class="text-2xl font-bold text-blue-900 mt-8 mb-4">$1</h3>')
                .replace(/## (.*?)$/gm, '<h2 class="text-3xl font-bold text-blue-900 mt-10 mb-6 pb-3 border-b-2 border-blue-200">$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-blue-900">$1</strong>')
                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-blue-700 hover:text-blue-900 underline">$1</a>')
                .replace(/\n\n/g, '</p><p class="mb-4 text-slate-700 leading-relaxed">')
                .replace(/\n/g, '<br>');
        }

        function render() {
            app.innerHTML = `
                <div class="max-w-6xl mx-auto px-6 py-12">
                    <!-- Header -->
                    <div class="text-center mb-16">
                        <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-blue-900 to-blue-700 rounded-3xl mb-6 shadow-2xl">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                            </svg>
                        </div>
                        <h1 class="text-5xl font-bold text-blue-900 mb-4 tracking-tight">AI News Aggregator</h1>
                        <p class="text-slate-600 text-xl max-w-2xl mx-auto mb-6">Official announcements from leading AI companies and latest research papers</p>
                        
                        ${state.sources ? `
                            <div class="inline-flex items-center gap-2 bg-white px-6 py-3 rounded-full shadow-lg">
                                <span class="text-sm font-semibold text-slate-600">Monitoring:</span>
                                <span class="text-sm font-bold text-blue-900">${state.sources.rss_feeds.length} RSS feeds</span>
                                <span class="text-slate-300">‚Ä¢</span>
                                <span class="text-sm font-bold text-blue-900">arXiv papers</span>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Action Card -->
                    <div class="bg-white rounded-3xl shadow-2xl p-10 mb-10 border-2 border-blue-100">
                        <div class="text-center">
                            <h3 class="text-2xl font-bold text-blue-900 mb-4">Generate Weekly Report</h3>
                            <p class="text-slate-600 mb-8">Automatically fetch and summarize the latest AI/ML news from official sources</p>
                            <button 
                                onclick="window.handleGenerate()"
                                ${state.loading ? 'disabled' : ''}
                                class="px-12 py-5 bg-gradient-to-r from-blue-900 to-blue-700 text-white rounded-2xl font-bold text-xl hover:shadow-xl hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100 transition-all duration-300">
                                ${state.loading ? '‚è≥ Processing...' : 'üöÄ Generate Report'}
                            </button>
                            ${state.error ? `<p class="text-red-600 font-semibold text-sm mt-6 bg-red-50 p-4 rounded-xl">${state.error}</p>` : ''}
                        </div>
                        
                        ${state.sources && !state.loading && !state.report ? `
                            <div class="mt-10 pt-8 border-t-2 border-slate-100">
                                <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wide mb-4">Monitored Sources</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${state.sources.rss_feeds.map(source => `
                                        <span class="px-4 py-2 bg-blue-50 text-blue-900 rounded-full text-sm font-medium">${source}</span>
                                    `).join('')}
                                    <span class="px-4 py-2 bg-green-50 text-green-900 rounded-full text-sm font-medium">arXiv Research</span>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Progress Card -->
                    ${state.loading ? `
                        <div class="bg-white rounded-3xl shadow-2xl p-10 mb-10 border-2 border-blue-100">
                            <h3 class="text-2xl font-bold text-blue-900 mb-8 text-center">Processing Your Request</h3>
                            <div class="space-y-6">
                                ${steps.map((step, idx) => {
                                    const isActive = state.currentStep === step.id;
                                    const isCompleted = state.currentStep > step.id;
                                    
                                    return `
                                        <div class="flex items-center gap-6">
                                            <div class="w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg transition-all duration-500 flex-shrink-0 ${
                                                isActive ? 'bg-gradient-to-br from-blue-900 to-blue-700 scale-110' : 
                                                isCompleted ? 'bg-gradient-to-br from-green-500 to-green-600' : 
                                                'bg-slate-100'
                                            }">
                                                <span class="text-2xl ${isActive || isCompleted ? '' : 'opacity-40'}">
                                                    ${isActive ? '‚è≥' : isCompleted ? '‚úÖ' : step.icon}
                                                </span>
                                            </div>
                                            <div class="flex-1">
                                                <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
                                                    <div class="h-full transition-all duration-500 ${
                                                        isCompleted ? 'w-full bg-gradient-to-r from-green-500 to-green-600' :
                                                        isActive ? 'w-1/2 bg-gradient-to-r from-blue-900 to-blue-700 pulse' :
                                                        'w-0 bg-slate-300'
                                                    }"></div>
                                                </div>
                                            </div>
                                            <span class="text-sm font-bold uppercase tracking-wide flex-shrink-0 ${
                                                isActive || isCompleted ? 'text-blue-900' : 'text-slate-400'
                                            }">${step.label}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Report Card -->
                    ${state.report ? `
                        <div class="bg-white rounded-3xl shadow-2xl p-10 border-2 border-blue-100">
                            <div class="flex flex-wrap items-center justify-between mb-8 pb-6 border-b-2 border-blue-100 gap-4">
                                <div>
                                    <h2 class="text-3xl font-bold text-blue-900 mb-2">Weekly AI/ML News Report</h2>
                                    <div class="flex items-center gap-4 text-sm">
                                        <span class="font-semibold text-slate-500">
                                            üìÖ ${state.report.date}
                                        </span>
                                        <span class="text-slate-300">‚Ä¢</span>
                                        <span class="font-semibold text-slate-500">
                                            üìä ${state.report.articles_count} articles
                                        </span>
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="window.copyToClipboard()"
                                        class="px-5 py-3 bg-blue-50 text-blue-900 rounded-xl font-bold text-sm hover:bg-blue-100 transition-all flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                        Copy
                                    </button>
                                    <button onclick="window.downloadMarkdown()"
                                        class="px-5 py-3 bg-blue-900 text-white rounded-xl font-bold text-sm hover:bg-blue-800 transition-all flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                        </svg>
                                        Markdown
                                    </button>
                                    <button onclick="window.downloadHTML()"
                                        class="px-5 py-3 bg-blue-900 text-white rounded-xl font-bold text-sm hover:bg-blue-800 transition-all flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                        </svg>
                                        HTML
                                    </button>
                                </div>
                            </div>
                            
                            <div class="prose prose-blue max-w-none">
                                <p class="mb-4 text-slate-700 leading-relaxed">
                                    ${formatMarkdown(state.report.report)}
                                </p>
                            </div>

                            <div class="mt-10 pt-8 border-t-2 border-slate-100">
                                <button onclick="window.handleGenerate()"
                                    class="w-full py-5 bg-gradient-to-r from-blue-900 to-blue-700 text-white rounded-2xl font-bold text-lg hover:shadow-xl hover:scale-105 transition-all duration-300 flex items-center justify-center gap-3">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    Generate New Report
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Expose functions to global scope
        window.handleGenerate = handleGenerate;
        window.downloadMarkdown = downloadMarkdown;
        window.downloadHTML = downloadHTML;
        window.copyToClipboard = copyToClipboard;

        // Initial render and load sources
        render();
        loadSources();
    </script>
</body>
</html>
